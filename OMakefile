.PHONY: all

USE_OCAMLFIND = true
NATIVE_ENABLED = true

OCAMLFLAGS = -thread -g -w @A-3-4-29-39-41-42-44-45-58 -bin-annot
OCAMLPACKS[] = core async async_extra async_find unix base64 str oUnit cohttp cohttp.async inifiles cryptokit nocrypto yojson ppx_deriving_yojson xml-light

mkdir -p _build
vmount(-l, src, _build)

.SUBDIRS: _build

    OCamlProgram(aws, aws s3)
    .DEFAULT: aws

.PHONY: clean dep install distclean unit-test integration-test
clean:
    $(RM) -r _build OMake*.omc
    $(RM) $(find . -name \*~)
    $(RM) -r .omake*

dep:
    opam install -y $(filter-out unix str inifiles cohttp.async, $(OCAMLPACKS)) ocaml-inifiles

integration-test: _build/integration-tests
    _build/integration-tests -runner sequential

unit-test: _build/unit-tests
    _build/unit-tests -runner sequential

.BUILD_BEGIN: .merlin
.merlin: OMakefile
    echo "FLG $(filter-out -O3 -bin-annot -g,$(OCAMLFLAGS))" > $@
    echo "S src" >> $@
    echo "B _build" >> $@
    echo PKG $(OCAMLPACKS) >> $@

distclean: clean
