.PHONY: all

USE_OCAMLFIND = true
NATIVE_ENABLED = true
BYTE_ENABLED = true

LIBNAME = Aws_s3

OFLAGS = -thread -g -w @A-4-39-41-44-45-58 -bin-annot
OCAMLPACKS[] = core async oUnit cohttp cohttp.async inifiles cryptokit nocrypto yojson ppx_deriving_yojson xml-light str

mkdir -p _build
mkdir -p _build
vmount(-l, src, _build)

.SUBDIRS: _build
  OCAMLFLAGS = $(OFLAGS) -for-pack $(LIBNAME)

  section:
    OCAMLFLAGS = $(OFLAGS)
    FILES[] = s3 credentials util
    OCamlPackage($(LIBNAME), $(FILES))

  section:
    OCAMLFLAGS = $(OFLAGS)
    OCamlProgram(aws, aws $(LIBNAME))
    .DEFAULT: aws

  .PHONY: uninstall install
  uninstall:
    -ocamlfind remove $(lowercase $(LIBNAME))

  LIBFILES = $(addsuffixes .cmi .cmo .cmt .cmx .o, $(LIBNAME))
  install: uninstall $(LIBFILES)
    ocamlfind install $(lowercase $(LIBNAME)) $(LIBFILES) ../META


.PHONY: clean dep distclean unit-test integration-test
clean:
    $(RM) -r _build OMake*.omc
    $(RM) $(find . -name \*~)
    $(RM) -r .omake*
    $(RM) .merlin src/.merlin

dep:
    opam install -y $(filter-out unix str inifiles cohttp.async, $(OCAMLPACKS)) ocaml-inifiles

integration-test: _build/integration-tests
    _build/integration-tests -runner sequential

unit-test: _build/unit-tests
    _build/unit-tests -runner sequential

.BUILD_BEGIN: .merlin
.merlin: OMakefile
    echo "FLG $(filter-out -O3 -bin-annot -g,$(OFLAGS))" > $@
    echo "S src" >> $@
    echo "B _build" >> $@
    echo PKG $(OCAMLPACKS) >> $@

distclean: clean
